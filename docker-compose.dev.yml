version: '3.8'

services:
  # Development frontend with hot reloading
  volview-insight-web:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile.dev
    environment:
      - NODE_ENV=development
      - VITE_REMOTE_SERVER_URL=http://localhost:4014/
      - VITE_DICOM_WEB_URL=http://localhost:5173/dicom-web/
      - VITE_FHIR_SERVER_URL=http://localhost:3000/hapi-fhir-jpaserver/fhir/
    volumes:
      - ./volview-insight/src:/app/volview-insight/src
      - ./core:/app/core
      - /app/node_modules
    # Command is handled by Dockerfile.dev

  # Development backend with debug logging
  backend:
    environment:
      - PYTHON_ENV=development
      - PYTHONUNBUFFERED=1
    volumes:
      - ./volview-insight/server:/app
      - model-cache:/app/models
    command: ["python", "-m", "volview_server", "-P", "4014", "-H", "0.0.0.0", "--verbose", "volview_insight_methods.py"]

  # Development orthanc proxy
  orthanc-proxy:
    environment:
      - NODE_ENV=development
    volumes:
      - ./volview-insight/orthanc-proxy:/app
      - /app/node_modules
    command: ["npm", "run", "dev"]

  # Development orthanc
  orthanc:
    environment:
      - ORTHANC__AUTHENTICATION_ENABLED=false
      - ORTHANC__REMOTE_ACCESS_ALLOWED=true
      - ORTHANC__DICOM_WEB_ENABLED=true
      - ORTHANC__DICOM_WEB_ROOT=/dicom-web/
      - ORTHANC__STORAGE_DIRECTORY=/var/lib/orthanc/db
      - ORTHANC__DATABASE_DIRECTORY=/var/lib/orthanc/db
      - ORTHANC__INDEX_DIRECTORY=/var/lib/orthanc/db
      - ORTHANC__HTTP_PORT=8042
      - ORTHANC__DICOM_PORT=4242
    volumes:
      - orthanc-data:/var/lib/orthanc/db