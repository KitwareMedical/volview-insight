version: '3.8'

services:
  # VolView Insight Web Application - Vite dev server with hot reloading
  volview-insight-web:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=development
      # Direct API calls to other services (browser â†’ localhost)
      - VITE_REMOTE_SERVER_URL=http://localhost:4014/
      - VITE_DICOM_WEB_URL=http://localhost:5173/dicom-web/
      - VITE_FHIR_SERVER_URL=http://localhost:3000/hapi-fhir-jpaserver/fhir/
      # Local FHIR configuration for the LocalFHIR component
      - VITE_LOCAL_FHIR_SERVER_URL=http://localhost:3000/hapi-fhir-jpaserver/fhir
      - VITE_LOCAL_FHIR_SERVER_NAME=Local HAPI FHIR Server
      - VITE_PATIENT_IDENTIFIER=http://mimic.mit.edu/fhir/mimic/identifier/patient
    volumes:
      # Live code reloading
      - ./volview-insight/src:/app/volview-insight/src
      - ./core:/app/core
      # Prevent node_modules conflicts
      - /app/node_modules
      - /app/volview-insight/node_modules
      - /app/core/VolView/node_modules
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "8080"]
    depends_on:
      - backend
      - orthanc-proxy
    networks:
      - volview-network

  # Python AI Backend Server
  backend:
    build:
      context: ./volview-insight/server
      dockerfile: ../../docker/backend/Dockerfile
    ports:
      - "4014:4014"
    environment:
      - HF_TOKEN=${HF_TOKEN}
      - PYTHONPATH=/app
      - PYTHON_ENV=development
      - PYTHONUNBUFFERED=1
    volumes:
      - ./volview-insight/server:/app
      - model-cache:/app/models
    command: ["python", "-m", "volview_server", "-P", "4014", "-H", "0.0.0.0", "--verbose", "volview_insight_methods.py"]
    depends_on:
      - orthanc
      - hapi-fhir
    networks:
      - volview-network

  # Orthanc DICOM Server
  orthanc:
    image: orthancteam/orthanc
    ports:
      - "8042:8042"  # HTTP API
      - "4242:4242"  # DICOM C-STORE
    environment:
      - ORTHANC__AUTHENTICATION_ENABLED=false
      - ORTHANC__REMOTE_ACCESS_ALLOWED=true
      - DICOM_WEB_PLUGIN_ENABLED=true
      - ORTHANC__HTTP_PORT=8042
      - ORTHANC__DICOM_PORT=4242
    volumes:
      - orthanc-data:/var/lib/orthanc/db

    networks:
      - volview-network

  # HAPI FHIR Server
  hapi-fhir:
    image: smartonfhir/hapi-5:r4-empty
    ports:
      - "3000:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:h2:file:/data/fhir
      - SPRING_DATASOURCE_USERNAME=sa
      - SPRING_DATASOURCE_PASSWORD=
    volumes:
      - hapi-fhir-data:/data

    networks:
      - volview-network

  # Orthanc CORS Proxy
  orthanc-proxy:
    build:
      context: ./volview-insight/orthanc-proxy
      dockerfile: ../../docker/orthanc-proxy/Dockerfile
    ports:
      - "5173:5173"
    environment:
      - ORTHANC_URL=http://orthanc:8042
      - NODE_ENV=development
    volumes:
      - ./volview-insight/orthanc-proxy:/app
      - /app/node_modules
    command: ["npm", "run", "dev"]
    depends_on:
      - orthanc
    networks:
      - volview-network

# Networks
networks:
  volview-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Volumes
volumes:
  orthanc-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes-db/orthanc-data
  
  hapi-fhir-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes-db/hapi-fhir-data
  
  model-cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes-db/model-cache