version: '3.8'

services:
  # VolView Insight Web Application
  volview-insight-web:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
    ports:
      - "8080:8080"  # Development server
      - "4173:4173"  # Preview server
    environment:
      - VITE_REMOTE_SERVER_URL=http://backend:4014/
      - VITE_DICOM_WEB_URL=http://orthanc-proxy:5173/dicom-web/
      - VITE_FHIR_SERVER_URL=http://hapi-fhir:3000/hapi-fhir-jpaserver/fhir/
      - NODE_ENV=production
    volumes:
      - ./volview-insight/src:/app/volview-insight/src
      - ./core:/app/core
    depends_on:
      - backend
      - orthanc-proxy
    networks:
      - volview-network

  # Python AI Backend Server
  backend:
    build:
      context: ./volview-insight/server
      dockerfile: ../../docker/backend/Dockerfile
    ports:
      - "4014:4014"
    environment:
      - HF_TOKEN=${HF_TOKEN}
      - PYTHONPATH=/app
      - PYTHON_ENV=production
    volumes:
      - ./volview-insight/server:/app
      - model-cache:/app/models
    depends_on:
      - orthanc
      - hapi-fhir
    networks:
      - volview-network

  # Orthanc DICOM Server
  orthanc:
    image: orthancteam/orthanc
    ports:
      - "8042:8042"  # HTTP API
      - "4242:4242"  # DICOM C-STORE
    environment:
      - ORTHANC__AUTHENTICATION_ENABLED=false
      - ORTHANC__REMOTE_ACCESS_ALLOWED=true
      - DICOM_WEB_PLUGIN_ENABLED=true
      - ORTHANC__STORAGE_DIRECTORY=/var/lib/orthanc/db
      - ORTHANC__DATABASE_DIRECTORY=/var/lib/orthanc/db
      - ORTHANC__INDEX_DIRECTORY=/var/lib/orthanc/db
      - ORTHANC__HTTP_PORT=8042
      - ORTHANC__DICOM_PORT=4242
    volumes:
      - orthanc-data:/var/lib/orthanc/db
    networks:
      - volview-network

  # HAPI FHIR Server
  hapi-fhir:
    image: smartonfhir/hapi-5:r4-empty
    ports:
      - "3000:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:h2:mem:fhir
      - SPRING_DATASOURCE_USERNAME=sa
      - SPRING_DATASOURCE_PASSWORD=
    volumes:
      - hapi-fhir-data:/data
    networks:
      - volview-network

  # Orthanc CORS Proxy
  orthanc-proxy:
    build:
      context: ./volview-insight/orthanc-proxy
      dockerfile: ../../docker/orthanc-proxy/Dockerfile
    ports:
      - "5173:5173"
    environment:
      - ORTHANC_URL=http://orthanc:8042
    depends_on:
      - orthanc
    networks:
      - volview-network

# Networks
networks:
  volview-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Volumes
volumes:
  orthanc-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes/orthanc-data
  
  hapi-fhir-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes/hapi-fhir-data
  
  model-cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes/model-cache